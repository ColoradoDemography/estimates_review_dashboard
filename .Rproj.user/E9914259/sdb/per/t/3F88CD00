{
    "contents" : "\nlibrary(shiny)\nlibrary(tidyr)\nlibrary(grid)\nlibrary(scales)\nlibrary(codemog)\nlibrary(dplyr)\nlibrary(ggplot2)\n\n#source(\"source_server.r\")\n\n# load(\"/opt/shiny-server/samples/sample-apps/codemog_data/county_est.rdata\")\n# load(\"/opt/shiny-server/samples/sample-apps/codemog_data/county_hist.rdata\")\n# load(\"/opt/shiny-server/samples/sample-apps/codemog_data/county_forecast.rdata\")\n# load(\"/opt/shiny-server/samples/sample-apps/codemog_data/muni_win_est.rdata\")\n# load(\"/opt/shiny-server/samples/sample-apps/codemog_data/muni_win_hist.rdata\")\n# load(\"/opt/shiny-server/samples/sample-apps/codemog_data/muni_hist.rdata\")\n# load(\"/opt/shiny-server/samples/sample-apps/codemog_data/muni_est.rdata\")\n# \n\n\n\ncounty_forecast=county_forecast\nc=read.csv(\"county_estimates_current.csv\", stringsAsFactors = FALSE)%>%\n  gather(var, value, -county:-region )%>%\n  separate(var, into=c(\"variable\", \"year\"))%>%\n  spread(variable, value)%>%\n  mutate(cv_pop=as.numeric(Population))%>%\n  select(county,countyfips, year, cv_pop)#%>%\n  #filter(countyfips!=0)\nmc=read.csv(\"muni_estimates_current.csv\", stringsAsFactors = FALSE)%>%\n  #filter(MuniTotalFlag==1)%>%\n  gather(var, value, -countyfips:-municipality)%>%\n  separate(var, into=c(\"variable\", \"year\"))%>%\n  filter(year!=\"2010c\")%>%\n  spread(variable, value)%>%\n  mutate(cv_pop=as.numeric(totalpopulation))%>%\n  select(municipality,countyfips,placefips, year, cv_pop)%>%\n  filter(placefips!=0)\nmch=read.csv(\"muni_estimates_current.csv\", stringsAsFactors = FALSE)%>%\n  #filter(MuniTotalFlag==1)%>%\n  gather(var, value, -countyfips:-municipality)%>%\n  separate(var, into=c(\"variable\", \"year\"))%>%\n  filter(year!=\"2010c\")%>%\n  spread(variable, value)%>%\n  mutate(cv_housing=as.numeric(totalHousingUnits))%>%\n  select(municipality,countyfips,placefips, year, cv_housing)%>%\n  filter(placefips!=0)\nmulti=read.csv(\"muni_estimates_current.csv\", stringsAsFactors = FALSE)%>%\n  filter(MuniTotalFlag==1)%>%\n  select(placefips, multi=MultiCountyPlaceFlag)\npv=read.csv(\"county_estimates_previous.csv\", stringsAsFactors = FALSE)%>%\n  gather(var, value,  -county:-region)%>%\n  separate(var, into=c(\"variable\", \"year\"))%>%\n  spread(variable, value)%>%\n  mutate(pv_pop=as.numeric(Population))%>%\n  select(county,countyfips, year, pv_pop)#%>%\n  #filter(countyfips!=0)\nmpv=read.csv(\"muni_estimates_previous.csv\", stringsAsFactors = FALSE)%>%\n  #filter(MuniTotalFlag==1)%>%\n  gather(var, value, -countyfips:-municipality)%>%\n  separate(var, into=c(\"variable\", \"year\"))%>%\n  filter(year!=\"2010c\")%>%\n  spread(variable, value)%>%\n  mutate(pv_pop=as.numeric(totalpopulation))%>%\n  select(municipality,placefips,countyfips, year, pv_pop)%>%\n  filter(placefips!=0)\nmpvh=read.csv(\"muni_estimates_previous.csv\", stringsAsFactors = FALSE)%>%\n  #filter(MuniTotalFlag==1)%>%\n  gather(var, value, -countyfips:-municipality)%>%\n  separate(var, into=c(\"variable\", \"year\"))%>%\n  filter(year!=\"2010c\")%>%\n  spread(variable, value)%>%\n  mutate(pv_housing=as.numeric(totalHousingUnits))%>%\n  select(municipality,placefips,countyfips, year, pv_housing)%>%\n  filter(placefips!=0)\nhist=county_hist%>%\n  filter(year<=2010, year>=2005)%>%\n  select(county, countyfips, year, totalPopulation)\nm_hist_one=muni_win_hist%>%\n  filter(year<=2010, year>=2005)%>%\n  select(municipality,countyfips, placefips, year, totalPopulation)%>%\n  mutate(countyfips=as.integer(countyfips),\n         placefips=as.integer(placefips))\nm_hist_multi=muni_hist%>%\n  filter(year<=2010, year>=2005)%>%\n  select(municipality, placefips, year, totalPopulation)%>%\n  mutate(countyfips=as.integer(999),\n         placefips=as.integer(placefips))%>%\n  bind_rows(m_hist_one)\n# m_hist=list(m=m_hist_multi, s=m_hist_one)\n\nts=c%>%\n  rename(totalPopulation=cv_pop)%>%\n  bind_rows(hist)%>%\n  left_join(pv, by=c(\"countyfips\", \"year\"))%>%\n  arrange(countyfips,year)%>%\n  group_by(countyfips)%>%\n  mutate(change=totalPopulation-lag(totalPopulation),\n         percent_change=round(100*(change/totalPopulation),2),\n         revision=totalPopulation-pv_pop)\nmts=mc%>%\n  rename(totalPopulation=cv_pop)%>%\n  bind_rows(m_hist_one)%>%\n  left_join(mpv )%>%\n  arrange(placefips,year)%>%\n  group_by(countyfips, placefips)%>%\n  mutate(\n#     change=totalPopulation-lag(totalPopulation),\n#          percent_change=round(100*(change/totalPopulation),2),\n         revision=totalPopulation-pv_pop)\n\nmtsh=mch%>%\n  rename(totalHousingUnits=cv_housing)%>%\n  left_join(mpvh)%>%\n  arrange(placefips,year)%>%\n  group_by(countyfips, placefips)%>%\n  mutate(\n    #     change=totalPopulation-lag(totalPopulation),\n    #          percent_change=round(100*(change/totalPopulation),2),\n    revision=totalHousingUnits-pv_housing)\nby=c(\"placefips\", \"year\")\ngd=hist%>%\n  bind_rows(c)%>%\n  bind_rows(pv)\ngdh=mch%>%\n  left_join(mpvh)\n\nmgd=m_hist_one%>%\n  bind_rows(mc)%>%\n  bind_rows(mpv)\ncomp=read.csv(\"county_estimates_current.csv\", stringsAsFactors = FALSE)%>%\n  gather(var, value, -county:-region )%>%\n  separate(var, into=c(\"variable\", \"year\"))%>%\n  spread(variable, value)%>%\n  mutate(NetMig=as.numeric(NetMig),\n         Births=as.numeric(Births),\n         Deaths=as.numeric(Deaths),\n         NatInc=Births-Deaths,\n         GQ_Change=as.numeric(GQ))%>%\n  select(-Population)%>%\n  filter(countyfips!=0)\n\npv_comp=read.csv(\"county_estimates_previous.csv\", stringsAsFactors = FALSE)%>%\n  gather(var, value, -county:-region )%>%\n  separate(var, into=c(\"variable\", \"year\"))%>%\n  spread(variable, value)%>%\n  mutate(pNetMig=as.numeric(NetMig),\n         pBirths=as.numeric(Births),\n         pDeaths=as.numeric(Deaths),\n         pNatInc=Births-Deaths,\n         pGQ=as.numeric(GQ))%>%\n  select(-Births:-Population)%>%\n  filter(countyfips!=0)\nts_comp=left_join(comp,pv_comp, by=c(\"county\", \"countyfips\", \"region\", \"year\"))%>%\n  mutate(GQChng=GQ,\n         NetMig_Revise=NetMig-pNetMig,\n         GQ_Revise=GQChng-pGQ,\n         NatInc_Revise=NatInc-pNatInc,\n         Births_Revise=Births-pBirths,\n         Deaths_Revise=Deaths-pDeaths)%>%\n  select(-GQ)\n\nc_names=county_est%>%\n  filter(year==2010)%>%\n  select(countyfips, county)\nm_names=muni_est%>%\n  filter(year==2010)%>%\n  select(placefips, municipality)\n\ntotalPop=function(data,fips){\n  fips=as.numeric(fips)\n  \n  d=filter(data, countyfips==fips)\n  \n  p=ggplot(d,aes(x=as.factor(year), y=as.integer(totalPopulation),group=countyfips))+\n    geom_line(color=rgb(31,74,126,max=255), size=1.75)+\n    labs(x=\"Year\", y=\"Population\", title=\"County Population\")+\n    scale_y_continuous(label=comma)+\n    \n    theme_codemog(base_size=12)+\n    theme(axis.text.x=element_text(angle=90))+\n    geom_point(aes(x=as.factor(year), y=pv_pop, label=\"Current\"), color=rgb(0,149,58,max=255), size=2.5)+\n    geom_point(aes(x=as.factor(year), y=cv_pop, label=\"Previous\"), color=rgb(191,32,38,max=255), size=2.5)\n  return(p)\n}\n\nmtotalPop=function(data,placefips){\n  fips=as.numeric(placefips)\n  \n  d=filter(data, placefips==fips)\n  \n  p=ggplot(d,aes(x=as.factor(year), y=as.integer(totalPopulation),group=countyfips))+\n             geom_line(color=rgb(31,74,126,max=255), size=1.75)+\n             labs(x=\"Year\", y=\"Population\", title=\"Municipal Population\")+\n             scale_y_continuous(label=comma)+\n             \n             theme_codemog(base_size=12)+\n             theme(axis.text.x=element_text(angle=90))+\n             geom_point(aes(x=as.factor(year), y=pv_pop, label=\"Previous\"), color=rgb(0,149,58,max=255), size=2.5)+\n             geom_point(aes(x=as.factor(year), y=cv_pop, label=\"Current\"), color=rgb(191,32,38,max=255), size=2.5)\n           return(p)\n}\nmtotalHousing=function(data,placefips){\n  fips=as.numeric(placefips)\n  \n  d=filter(data, placefips==fips)\n  \n  p=ggplot(d,aes(group=countyfips))+\n    geom_point(aes(x=as.factor(year), y=pv_housing, label=\"Previous\"), color=rgb(0,149,58,max=255), size=2.5)+\n    geom_point(aes(x=as.factor(year), y=cv_housing, label=\"Current\"), color=rgb(191,32,38,max=255), size=2.5)+\n    labs(x=\"Year\", y=\"Population\", title=\"Municipal Total Housing\")+\n    scale_y_continuous(label=comma)+\n    theme_codemog(base_size=12)+\n    theme(axis.text.x=element_text(angle=90))\n\n  return(p)\n}\n\nchangePop=function(data,fips){\n  fips=as.numeric(fips)\n  \n  d=filter(data, countyfips==fips)\n  \n  p=ggplot(d,aes(x=as.factor(year), y=as.numeric(percent_change),group=countyfips))+\n    geom_bar(stat=\"identity\",fill=rgb(31,74,126,max=255))+\n    labs(x=\"Year\", y=\"Population\", title=\"County Population Change (%)\")+\n    #scale_y_continuous(label=comma)+\n    theme_codemog(base_size=12)+\n    theme(axis.text.x=element_text(angle=90))\n  return(p)\n}\n\nshinyServer(function(input, output) {\n  cntyfips=reactive({c_names%>%filter(county==input$cnty)%>%select(countyfips)})\n plcfips=reactive({m_names%>%filter(municipality==input$muni)%>%select(placefips)})\n  mtotalPlot_input=reactive({mtotalPop(data=mgd, placefips=plcfips())})\n  output$mtotalPlot=renderPlot({mtotalPlot_input()})\n  mtotalHousing_input=reactive({mtotalHousing(data=gdh, placefips=plcfips())})\n  output$housingPlot=renderPlot({mtotalHousing_input()})\n  totalPlot_input=reactive({totalPop(data=gd, fips=cntyfips())})\n  output$totalPlot=renderPlot({totalPlot_input()})\n  changePlot_input=reactive({changePop(data=ts, fips=cntyfips())})\n  output$changePlot=renderPlot({changePlot_input()})\n  control_in=reactive({county_ts_chart(cntyfips())})\n  output$control=renderPlot({control_in()})\n  ts_in=reactive({ts%>%filter(countyfips==as.numeric(cntyfips()))%>%select(year,totalPopulation, change, percent_change, revision)})\n  output$popTable=renderDataTable({ts_in()})\n  mts_in=reactive({mts%>%filter(placefips==as.numeric(plcfips()))%>%select(year,totalPopulation, revision)})\n  output$mpopTable=renderDataTable({mts_in()})\n  mtsh_in=reactive({mtsh%>%filter(placefips==as.numeric(plcfips()))%>%select(year,totalHousingUnits, revision)})\n  output$housingTable=renderDataTable({mtsh_in()})\n  comp_in=reactive({filter(ts_comp, countyfips==as.numeric(cntyfips()))})\n  output$compTable=renderDataTable({comp_in()%>%select(year,NetMig, NetMig_Revise, GQChng, GQ_Revise,Births, Deaths, NatInc, NatInc_Revise )})\n  output$popTableRank=renderDataTable({ts%>%select(county.x,year, totalPopulation, change, percent_change, revision)})\n})\n",
    "created" : 1426532538598.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "759185986",
    "id" : "3F88CD00",
    "lastKnownWriteTime" : 1436557791,
    "path" : "J:/Estimates/Admin/AppDevelopment/estimates_review_dashboard/server.R",
    "project_path" : "server.R",
    "properties" : {
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "type" : "r_source"
}